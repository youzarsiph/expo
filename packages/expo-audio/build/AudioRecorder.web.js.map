{"version":3,"file":"AudioRecorder.web.js","sourceRoot":"","sources":["../src/AudioRecorder.web.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  RecorderState,\n  RecordingInput,\n  RecordingOptions,\n  RecordingOptionsWeb,\n  RecordingStartOptions,\n} from './Audio.types';\nimport { RECORDING_STATUS_UPDATE } from './AudioEventKeys';\nimport { AudioRecorder, RecordingEvents } from './AudioModule.types';\nimport { getAudioContext, getUserMedia, nextId } from './AudioUtils.web';\nimport { RecordingPresets } from './RecordingConstants';\n\nexport class AudioRecorderWeb\n  extends globalThis.expo.SharedObject<RecordingEvents>\n  implements AudioRecorder\n{\n  constructor(options: Partial<RecordingOptions>) {\n    super();\n    this.options = options;\n  }\n\n  async setup() {\n    this.mediaRecorder = await this.createMediaRecorder(this.options);\n  }\n\n  id = nextId();\n  currentTime = 0;\n  uri: string | null = null;\n\n  private options: Partial<RecordingOptions>;\n  private mediaRecorder: MediaRecorder | null = null;\n  private mediaRecorderUptimeOfLastStartResume = 0;\n  private mediaRecorderIsRecording = false;\n  private timeoutIds: number[] = [];\n  private cachedInputs: RecordingInput[] = [];\n  private selectedDeviceId: string | null = null;\n  private stream: MediaStream | null = null;\n  private handleDeviceChange: (() => void) | null = null;\n  private analyser: AnalyserNode | null = null;\n  private analyserBuffer: Float32Array<ArrayBuffer> | null = null;\n  private analyserSource: MediaStreamAudioSourceNode | null = null;\n  private meteringEnabled = false;\n\n  get isRecording(): boolean {\n    return this.mediaRecorder?.state === 'recording';\n  }\n\n  record(options?: RecordingStartOptions): void {\n    if (this.mediaRecorder === null) {\n      throw new Error(\n        'Cannot start an audio recording without initializing a MediaRecorder. Run prepareToRecordAsync() before attempting to start an audio recording.'\n      );\n    }\n\n    // Clear any existing timeouts\n    this.clearTimeouts();\n\n    // Note: atTime is not supported on Web (no native equivalent), so we ignore it entirely\n    // Only forDuration is implemented using setTimeout\n    const { forDuration } = options || {};\n\n    this.startActualRecording();\n\n    if (forDuration !== undefined) {\n      this.timeoutIds.push(\n        setTimeout(() => {\n          this.stop();\n        }, forDuration * 1000)\n      );\n    }\n  }\n\n  private startActualRecording(): void {\n    if (this.mediaRecorder?.state === 'paused') {\n      this.mediaRecorder.resume();\n    } else {\n      this.mediaRecorder?.start();\n    }\n  }\n\n  getAvailableInputs(): RecordingInput[] {\n    return this.cachedInputs;\n  }\n\n  getCurrentInput(): Promise<RecordingInput> {\n    const deviceId =\n      this.selectedDeviceId ?? this.stream?.getAudioTracks()[0]?.getSettings().deviceId;\n    const matched = this.cachedInputs.find((input) => input.uid === deviceId);\n    if (matched) {\n      return Promise.resolve(matched);\n    }\n    return Promise.resolve(\n      this.cachedInputs[0] ?? {\n        type: 'Default',\n        name: 'Default',\n        uid: 'Default',\n      }\n    );\n  }\n\n  async prepareToRecordAsync(): Promise<void> {\n    return this.setup();\n  }\n\n  getStatus(): RecorderState {\n    const status: RecorderState = {\n      canRecord:\n        this.mediaRecorder?.state === 'recording' || this.mediaRecorder?.state === 'inactive',\n      isRecording: this.mediaRecorder?.state === 'recording',\n      durationMillis: this.getAudioRecorderDurationMillis(),\n      mediaServicesDidReset: false,\n      url: this.uri,\n    };\n    if (this.meteringEnabled && this.mediaRecorderIsRecording) {\n      status.metering = this.getMeteringLevel();\n    }\n    return status;\n  }\n\n  pause(): void {\n    if (this.mediaRecorder === null) {\n      throw new Error(\n        'Cannot start an audio recording without initializing a MediaRecorder. Run prepareToRecordAsync() before attempting to start an audio recording.'\n      );\n    }\n\n    this.mediaRecorder?.pause();\n  }\n\n  recordForDuration(seconds: number): void {\n    this.record({ forDuration: seconds });\n  }\n\n  setInput(input: string): void {\n    if (!this.cachedInputs.some((cached) => cached.uid === input)) {\n      throw new Error(`No audio input device found for uid: ${input}`);\n    }\n    this.selectedDeviceId = input;\n  }\n\n  startRecordingAtTime(seconds: number): void {\n    this.record({ atTime: seconds });\n  }\n\n  async stop(): Promise<void> {\n    if (this.mediaRecorder === null) {\n      throw new Error(\n        'Cannot start an audio recording without initializing a MediaRecorder. Run prepareToRecordAsync() before attempting to start an audio recording.'\n      );\n    }\n\n    const dataPromise = new Promise<Blob>((resolve) =>\n      this.mediaRecorder?.addEventListener('dataavailable', (e) => resolve(e.data))\n    );\n\n    this.mediaRecorder?.stop();\n    this.mediaRecorder = null;\n\n    const data = await dataPromise;\n    const url = URL.createObjectURL(data);\n\n    this.uri = url;\n\n    this.emit(RECORDING_STATUS_UPDATE, {\n      id: this.id,\n      isFinished: true,\n      hasError: false,\n      error: null,\n      url,\n    });\n  }\n\n  clearTimeouts() {\n    this.timeoutIds.forEach((id) => clearTimeout(id));\n  }\n\n  private async createMediaRecorder(\n    options: Partial<RecordingOptions> & Partial<RecordingOptionsWeb>\n  ): Promise<MediaRecorder> {\n    if (typeof navigator !== 'undefined' && !navigator.mediaDevices) {\n      throw new Error('No media devices available');\n    }\n\n    this.mediaRecorderUptimeOfLastStartResume = 0;\n    this.currentTime = 0;\n\n    const audioConstraints = this.selectedDeviceId\n      ? { deviceId: { exact: this.selectedDeviceId } }\n      : true;\n    const stream = await getUserMedia({ audio: audioConstraints });\n    this.stream = stream;\n\n    await this.updateCachedInputs();\n\n    this.handleDeviceChange = () => {\n      this.updateCachedInputs();\n    };\n    navigator.mediaDevices.addEventListener('devicechange', this.handleDeviceChange);\n\n    if (options.isMeteringEnabled) {\n      const ctx = getAudioContext();\n      if (ctx.state === 'suspended') {\n        ctx.resume();\n      }\n      this.analyserSource = ctx.createMediaStreamSource(stream);\n      this.analyser = ctx.createAnalyser();\n      this.analyser.fftSize = 2048;\n      this.analyserSource.connect(this.analyser);\n      this.analyserBuffer = new Float32Array(this.analyser.frequencyBinCount);\n      this.meteringEnabled = true;\n    }\n\n    const defaults = RecordingPresets.HIGH_QUALITY.web;\n    const mediaRecorderOptions: MediaRecorderOptions = {};\n\n    const mimeType = options.mimeType ?? defaults.mimeType;\n    if (mimeType && MediaRecorder.isTypeSupported(mimeType)) {\n      mediaRecorderOptions.mimeType = mimeType;\n    }\n\n    if (options.bitsPerSecond) {\n      mediaRecorderOptions.bitsPerSecond = options.bitsPerSecond;\n    } else if (options.bitRate) {\n      mediaRecorderOptions.audioBitsPerSecond = options.bitRate;\n    } else {\n      mediaRecorderOptions.bitsPerSecond = defaults.bitsPerSecond;\n    }\n\n    const mediaRecorder = new MediaRecorder(stream, mediaRecorderOptions);\n\n    mediaRecorder.addEventListener('pause', () => {\n      this.currentTime = this.getAudioRecorderDurationMillis();\n      this.mediaRecorderIsRecording = false;\n    });\n\n    mediaRecorder.addEventListener('resume', () => {\n      this.mediaRecorderUptimeOfLastStartResume = Date.now();\n      this.mediaRecorderIsRecording = true;\n    });\n\n    mediaRecorder.addEventListener('start', () => {\n      this.mediaRecorderUptimeOfLastStartResume = Date.now();\n      this.currentTime = 0;\n      this.mediaRecorderIsRecording = true;\n    });\n\n    mediaRecorder?.addEventListener('stop', () => {\n      this.currentTime = 0;\n      this.mediaRecorderIsRecording = false;\n      this.stream = null;\n\n      if (this.analyserSource) {\n        this.analyserSource.disconnect();\n        this.analyserSource = null;\n      }\n      if (this.analyser) {\n        this.analyser.disconnect();\n        this.analyser = null;\n        this.analyserBuffer = null;\n      }\n\n      if (this.handleDeviceChange) {\n        navigator.mediaDevices?.removeEventListener('devicechange', this.handleDeviceChange);\n        this.handleDeviceChange = null;\n      }\n\n      // Clears recording icon in Chrome tab\n      stream.getTracks().forEach((track) => track.stop());\n    });\n\n    return mediaRecorder;\n  }\n\n  private async updateCachedInputs() {\n    const devices = await navigator.mediaDevices.enumerateDevices();\n    this.cachedInputs = devices\n      .filter((device) => device.kind === 'audioinput')\n      .map((device) => ({\n        uid: device.deviceId,\n        name: device.label || 'Unknown Device',\n        type: device.deviceId === 'default' ? 'Default' : 'Unknown',\n      }));\n  }\n\n  // Compute the metering level in dBFS using the same RMS-to-decibel formula as\n  // native (20 * log10(rms)). -160 represents silence / no signal.\n  private getMeteringLevel(): number {\n    if (!this.analyser || !this.analyserBuffer) {\n      return -160;\n    }\n    this.analyser.getFloatTimeDomainData(this.analyserBuffer);\n    let sumSquares = 0;\n    for (let i = 0; i < this.analyserBuffer.length; i++) {\n      sumSquares += this.analyserBuffer[i] * this.analyserBuffer[i];\n    }\n    const rms = Math.sqrt(sumSquares / this.analyserBuffer.length);\n    if (rms === 0) {\n      return -160;\n    }\n    return 20 * Math.log10(rms);\n  }\n\n  private getAudioRecorderDurationMillis() {\n    let duration = this.currentTime;\n    if (this.mediaRecorderIsRecording && this.mediaRecorderUptimeOfLastStartResume > 0) {\n      duration += Date.now() - this.mediaRecorderUptimeOfLastStartResume;\n    }\n    return duration;\n  }\n}\n"]}