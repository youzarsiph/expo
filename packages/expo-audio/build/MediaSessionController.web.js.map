{"version":3,"file":"MediaSessionController.web.js","sourceRoot":"","sources":["../src/MediaSessionController.web.ts"],"names":[],"mappings":"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","sourcesContent":["import { AudioMetadata } from './Audio.types';\nimport { AudioLockScreenOptions } from './AudioConstants';\n\ninterface MediaSessionPlayer {\n  play(): void;\n  pause(): void;\n  seekTo(seconds: number): Promise<void>;\n  readonly playing: boolean;\n  readonly currentTime: number;\n  readonly duration: number;\n  readonly playbackRate: number;\n}\n\nconst SKIP_SECONDS = 10;\n\nclass MediaSessionController {\n  private activePlayer: MediaSessionPlayer | null = null;\n  private metadata: AudioMetadata | null = null;\n  private options: AudioLockScreenOptions | null = null;\n\n  setActivePlayer(\n    player: MediaSessionPlayer,\n    metadata?: AudioMetadata,\n    options?: AudioLockScreenOptions\n  ): void {\n    if (!navigator.mediaSession) return;\n\n    if (this.activePlayer && this.activePlayer !== player) {\n      this.clear(this.activePlayer);\n    }\n\n    this.activePlayer = player;\n    this.metadata = metadata ?? null;\n    this.options = options ?? null;\n\n    this._applyMetadata();\n    this._applyActionHandlers();\n    this.updatePlaybackState(player);\n    this.updatePositionState(player);\n  }\n\n  updateMetadata(player: MediaSessionPlayer, metadata: AudioMetadata): void {\n    if (!navigator.mediaSession) return;\n    if (this.activePlayer !== player) return;\n\n    this.metadata = metadata;\n    this._applyMetadata();\n  }\n\n  clear(player: MediaSessionPlayer): void {\n    if (!navigator.mediaSession) return;\n    if (this.activePlayer !== player) return;\n\n    this.activePlayer = null;\n    this.metadata = null;\n    this.options = null;\n\n    navigator.mediaSession.metadata = null;\n    navigator.mediaSession.playbackState = 'none';\n\n    const actions: MediaSessionAction[] = [\n      'play',\n      'pause',\n      'seekto',\n      'seekforward',\n      'seekbackward',\n      'previoustrack',\n      'nexttrack',\n    ];\n    for (const action of actions) {\n      this._setHandler(action, null);\n    }\n\n    try {\n      navigator.mediaSession.setPositionState();\n    } catch {}\n  }\n\n  updatePlaybackState(player: MediaSessionPlayer): void {\n    if (!navigator.mediaSession) return;\n    if (this.activePlayer !== player) return;\n\n    navigator.mediaSession.playbackState = player.playing ? 'playing' : 'paused';\n  }\n\n  updatePositionState(player: MediaSessionPlayer): void {\n    if (!navigator.mediaSession) return;\n    if (this.activePlayer !== player) return;\n\n    const duration = player.duration;\n\n    if (!Number.isFinite(duration) || duration <= 0) return;\n\n    const position = Math.min(Math.max(player.currentTime, 0), duration);\n    const playbackRate = player.playbackRate || 1;\n\n    try {\n      navigator.mediaSession.setPositionState({\n        duration,\n        playbackRate,\n        position,\n      });\n    } catch {}\n  }\n\n  isActive(player: MediaSessionPlayer): boolean {\n    return this.activePlayer === player;\n  }\n\n  getActiveState(\n    player: MediaSessionPlayer\n  ): { metadata: AudioMetadata | null; options: AudioLockScreenOptions | null } | null {\n    if (this.activePlayer !== player) return null;\n    return { metadata: this.metadata, options: this.options };\n  }\n\n  private _applyMetadata(): void {\n    if (!this.metadata) {\n      navigator.mediaSession.metadata = null;\n      return;\n    }\n\n    const { title, artist, albumTitle, artworkUrl } = this.metadata;\n    const artwork: MediaImage[] = artworkUrl ? [{ src: artworkUrl }] : [];\n\n    navigator.mediaSession.metadata = new MediaMetadata({\n      title: title ?? '',\n      artist: artist ?? '',\n      album: albumTitle ?? '',\n      artwork,\n    });\n  }\n\n  private _setHandler(action: MediaSessionAction, handler: MediaSessionActionHandler | null): void {\n    try {\n      navigator.mediaSession.setActionHandler(action, handler);\n    } catch {}\n  }\n\n  private _applyActionHandlers(): void {\n    const player = this.activePlayer;\n    if (!player) return;\n\n    this._setHandler('play', () => {\n      player.play();\n    });\n\n    this._setHandler('pause', () => {\n      player.pause();\n    });\n\n    this._setHandler('seekto', (details) => {\n      if (details.seekTime != null) {\n        player.seekTo(details.seekTime);\n        this.updatePositionState(player);\n      }\n    });\n\n    const seekForward = (details: MediaSessionActionDetails) => {\n      const skipTime = details.seekOffset ?? SKIP_SECONDS;\n      const newTime = Math.min(player.currentTime + skipTime, player.duration || 0);\n      player.seekTo(newTime);\n      this.updatePositionState(player);\n    };\n\n    const seekBackward = (details: MediaSessionActionDetails) => {\n      const skipTime = details.seekOffset ?? SKIP_SECONDS;\n      const newTime = Math.max(player.currentTime - skipTime, 0);\n      player.seekTo(newTime);\n      this.updatePositionState(player);\n    };\n\n    if (this.options?.showSeekForward === true) {\n      this._setHandler('seekforward', seekForward);\n      this._setHandler('nexttrack', seekForward);\n    } else {\n      this._setHandler('seekforward', null);\n      this._setHandler('nexttrack', null);\n    }\n\n    if (this.options?.showSeekBackward === true) {\n      this._setHandler('seekbackward', seekBackward);\n      this._setHandler('previoustrack', seekBackward);\n    } else {\n      this._setHandler('seekbackward', null);\n      this._setHandler('previoustrack', null);\n    }\n  }\n}\n\nexport const mediaSessionController = new MediaSessionController();\n"]}